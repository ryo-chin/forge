name: Prototype Deploy

on:
#  push:
#    branches:
#      - '**prototype**'
  workflow_dispatch:
    inputs:
      branch:
        description: 'デプロイ対象ブランチ（`prototype` を含むこと）'
        required: true
        type: string

jobs:
  deploy-prototype:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    env:
      EVENT_NAME: ${{ github.event_name }}
      MANUAL_BRANCH: ${{ inputs.branch }}
      DEFAULT_REF: ${{ github.ref_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.branch || github.ref_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Derive branch info
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            branch="$MANUAL_BRANCH"
            if [ -z "$branch" ]; then
              echo "::error::workflow_dispatch では branch 入力が必要です" >&2
              exit 1
            fi
          else
            branch="$DEFAULT_REF"
          fi

          if [[ "$branch" != *prototype* ]]; then
            echo "::error::ブランチ名に prototype を含めてください: $branch" >&2
            exit 1
          fi

          sanitized=$(echo "$branch" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-+|-+$//g')
          if [ -z "$sanitized" ]; then
            sanitized="prototype"
          fi

          echo "branch_raw=$branch" >> "$GITHUB_OUTPUT"
          echo "branch_sanitized=$sanitized" >> "$GITHUB_OUTPUT"

      - name: Ensure prototype directory exists
        shell: bash
        run: |
          set -euo pipefail
          dir="prototype/${{ steps.vars.outputs.branch_raw }}"
          if [ ! -d "$dir" ]; then
            echo "::error::プロトタイプディレクトリが存在しません: $dir" >&2
            exit 1
          fi

      - name: Validate project directory
        shell: bash
        working-directory: prototype/${{ steps.vars.outputs.branch_raw }}
        run: |
          set -euo pipefail

          if [ ! -f package.json ]; then
            echo "::error::package.json が見つかりません。npm run build を実行できません" >&2
            exit 1
          fi

          if [ ! -f wrangler.toml ]; then
            echo "::error::wrangler.toml が見つかりません。Wrangler の設定を追加してください" >&2
            exit 1
          fi

      - name: Install dependencies
        shell: bash
        working-directory: prototype/${{ steps.vars.outputs.branch_raw }}
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-fund --no-audit
          fi

      - name: Run build
        shell: bash
        working-directory: prototype/${{ steps.vars.outputs.branch_raw }}
        env:
          BRANCH_NAME_RAW: ${{ steps.vars.outputs.branch_raw }}
          SANITIZED_BRANCH: ${{ steps.vars.outputs.branch_sanitized }}
        run: |
          set -euo pipefail
          npm run build

      - name: Deploy with Wrangler
        id: deploy
        shell: bash
        env:
          BRANCH_NAME_RAW: ${{ steps.vars.outputs.branch_raw }}
          SANITIZED_BRANCH: ${{ steps.vars.outputs.branch_sanitized }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        working-directory: prototype/${{ steps.vars.outputs.branch_raw }}
        run: |
          set -euo pipefail

          if [ -z "${CLOUDFLARE_API_TOKEN:-}" ] || [ -z "${CLOUDFLARE_ACCOUNT_ID:-}" ]; then
            echo "::error::CLOUDFLARE_API_TOKEN と CLOUDFLARE_ACCOUNT_ID をリポジトリシークレットに設定してください" >&2
            exit 1
          fi

          export NPX_YES=1
          logfile="$(mktemp)"

          if ! NPX_YES=1 npx wrangler deploy \
            --name "$SANITIZED_BRANCH" \
            --var "BRANCH_NAME=$BRANCH_NAME_RAW" \
            | tee "$logfile"; then
            echo "::error::wrangler deploy に失敗しました" >&2
            cat "$logfile" >&2
            exit 1
          fi

          deploy_url="$(grep -oE 'https://[a-zA-Z0-9.-]+\.workers\.dev' "$logfile" | tail -n1 || true)"

          if [ -z "$deploy_url" ]; then
            deploy_url=$(NPX_YES=1 npx wrangler deployments list \
              --name "$SANITIZED_BRANCH" \
              | grep -oE 'https://[a-zA-Z0-9.-]+\.workers\.dev' | head -n1 || true)
          fi

          rm -f "$logfile"

          if [ -n "$deploy_url" ]; then
            echo "DEPLOY_URL=$deploy_url" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::デプロイ URL を特定できませんでした。wrangler の出力を確認してください" >&2
          fi

      - name: Summarize deploy result
        if: ${{ steps.deploy.outputs.DEPLOY_URL != '' }}
        shell: bash
        run: |
          cat <<REPORT >> "$GITHUB_STEP_SUMMARY"
          ## Prototype Deploy
          - ブランチ: `${{ steps.vars.outputs.branch_raw }}`
          - Worker 名: `${{ steps.vars.outputs.branch_sanitized }}`
          - URL: [${{ steps.deploy.outputs.DEPLOY_URL }}](${{ steps.deploy.outputs.DEPLOY_URL }})
          REPORT

      - name: Comment on PR
        if: ${{ steps.deploy.outputs.DEPLOY_URL != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');
            const {owner, repo} = context.repo;
            const branch = `${{ steps.vars.outputs.branch_raw }}`;
            const url = `${{ steps.deploy.outputs.DEPLOY_URL }}`;

            const {data: prs} = await github.rest.pulls.list({
              owner,
              repo,
              head: `${owner}:${branch}`,
              state: 'open'
            });

            if (!prs.length) {
              core.info('対象 PR が見つかりませんでした。コメント投稿をスキップします。');
              return;
            }

            const body = [
              '🚀 プロトタイプを Cloudflare Workers にデプロイしました。',
              '',
              `- ブランチ: \`${branch}\``,
              `- URL: ${url}`
            ].join('\n');

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prs[0].number,
              body
            });
