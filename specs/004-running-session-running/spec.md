# Feature Specification: Running Session同期機能

**Feature Branch**: `004-running-session-running`
**Created**: 2025-10-19
**Status**: Draft
**Input**: User description: "現状、Running中のSessionを永続化していないため、複数デバイス間でRunning中セッションを共有することができません。これを可能にしてほしいです。また、Google連携のシートにも同じようにRunning中のSessionが同期されている状態にしたいです。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - デバイス間でRunning中セッションを引き継ぐ (Priority: P1)

スマホで作業を開始した後、PCに移動して同じセッションを続けたいユーザーが、デバイスを切り替えても作業を中断せずに継続できる。

**Why this priority**: この機能は「複数デバイスでタイムトラッカーを使う」という基本的なユースケースを満たす最も重要な要件。これがないと、ユーザーはデバイスごとに別々のセッションを管理しなければならず、ユーザー体験が著しく損なわれる。

**Independent Test**: デバイスAでセッションを開始し、デバイスBでアプリを開いたときに同じRunning中のセッションが表示され、継続できることで検証可能。この機能単体でMVPとして価値を提供する。

**Acceptance Scenarios**:

1. **Given** ユーザーがデバイスAでセッション「資料作成」を開始している、**When** デバイスBでアプリを開く、**Then** 同じセッション「資料作成」がRunning中として表示され、経過時間が正しく引き継がれている
2. **Given** ユーザーがデバイスAでRunning中のセッションのタイトルを「資料作成」から「プレゼン準備」に変更した、**When** デバイスBでアプリをリロードする、**Then** デバイスBにも「プレゼン準備」として反映されている
3. **Given** ユーザーがデバイスAでRunning中のセッションにプロジェクト「新規事業」を設定した、**When** デバイスBでアプリをリロードする、**Then** デバイスBにも同じプロジェクト名が表示される
4. **Given** ユーザーがデバイスAでRunning中のセッションにタグ「重要」「緊急」を追加した、**When** デバイスBでアプリをリロードする、**Then** デバイスBにも同じタグが表示される
5. **Given** ユーザーがデバイスAでRunning中のセッションのメモ、スキル、強度を編集した、**When** デバイスBでアプリをリロードする、**Then** すべての変更がデバイスBにも反映されている
6. **Given** ユーザーがデバイスBでRunning中のセッションを停止した、**When** デバイスAでアプリをリロードする、**Then** デバイスAでもセッションが停止済みとして表示され、履歴に追加されている

---

### User Story 2 - Google Sheetsへのリアルタイム同期 (Priority: P2)

Google Sheets連携を有効にしているユーザーが、Running中のセッション情報をスプレッドシート上でリアルタイムに確認できる。

**Why this priority**: 既存のGoogle Sheets同期機能の拡張であり、ユーザーからの要望も高い。完了セッションの同期は既に実装されているため、Running中も同期することで外部ツールでの進捗確認が可能になる。デバイス間同期の次に重要な機能としてP2に位置づける。

**Independent Test**: Google Sheets連携を設定し、セッション開始時にシート上に「Running」状態の行が追加され、停止時に確定されることで検証可能。

**Acceptance Scenarios**:

1. **Given** ユーザーがGoogle Sheets連携を有効にしている、**When** 新しいセッションを開始する、**Then** スプレッドシートに新しい行が追加され、ステータスが「Running」として表示される
2. **Given** Running中のセッションがスプレッドシートに同期されている、**When** セッションのタイトルを変更する、**Then** スプレッドシート上のタイトル列も更新される
3. **Given** Running中のセッションがスプレッドシートに同期されている、**When** プロジェクト名を設定する、**Then** スプレッドシート上のプロジェクト列も更新される
4. **Given** Running中のセッションがスプレッドシートに同期されている、**When** タグ、スキル、強度、メモを追加・編集する、**Then** スプレッドシート上の対応する列もすべて更新される
5. **Given** Running中のセッションがスプレッドシートに同期されている、**When** ユーザーが数時間経過後にアプリをリロードする、**Then** スプレッドシート上の経過時間も最新の値に更新される
6. **Given** Running中のセッションがスプレッドシートに同期されている、**When** セッションを停止する、**Then** スプレッドシート上のステータスが「Completed」に変更され、終了時刻と合計時間が確定される

---

### Edge Cases

- **複数デバイスで同時に新規セッションを開始した場合**: 最後に同期されたセッションを有効なRunning状態とする（Last Write Wins）
- **ネットワークエラーで同期が失敗した場合**: ローカルの状態を保持し、計測を継続する。ユーザーは手動でリロード・再試行することで同期を再開できる
- **他のデバイスでセッションが停止されたがローカルでRunning中の場合**: サーバーからの状態を優先し、ローカルのRunning状態を停止する
- **Google Sheets連携がエラーになった場合**: アプリ内のタイムトラッカー機能は正常動作し続ける（Google Sheets同期はベストエフォート）
- **Running中のセッションがない状態で同期要求が来た場合**: 何も変更せず、正常終了として扱う
- **LocalStorageモードの場合**: Running状態は従来通りローカルのみに保存され、デバイス間同期は行わない（Supabaseモードのみ対応）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはSupabaseモード時、Running中のセッション状態（タイトル、開始時刻、経過時間、プロジェクト、タグ、スキル、強度、メモ）をサーバーに自動保存しなければならない
- **FR-002**: システムは別デバイスでアプリを起動・リロードした際、サーバーに保存されているRunning中のセッション状態を自動的に取得し、表示しなければならない
- **FR-003**: ユーザーがRunning中のセッション情報（タイトル、プロジェクト、タグ、スキル、強度、メモ）を編集した場合、その変更をサーバーに同期しなければならない
- **FR-004**: システムは同期エラーが発生した場合でも、ローカルのタイムトラッカー機能を継続して利用可能にしなければならない
- **FR-005**: Google Sheets連携が有効な場合、セッション開始時にスプレッドシートに新しい行を追加し、ステータスを「Running」として記録しなければならない
- **FR-006**: Running中のセッション情報（タイトル、プロジェクト、タグ、スキル、強度、メモ、経過時間）が更新された場合、Google Sheetsの対応する行も更新しなければならない
- **FR-007**: セッションが停止された場合、Google Sheets上のステータスを「Completed」に変更し、終了時刻と合計時間を確定しなければならない
- **FR-008**: LocalStorageモードの場合、Running状態は従来通りローカルストレージのみに保存し、サーバー同期は行わない
- **FR-009**: システムは複数デバイスで同時編集が発生した場合、最後に更新された状態を有効とする（Last Write Wins）

### Key Entities

- **Running Session State**: Running中のセッション全体の状態を表す。ステータス（running/idle）、セッションドラフト、経過時間を含む
- **Session Draft**: Running中のセッションの詳細情報。タイトル、開始時刻、プロジェクト名、タグ、スキル、強度、メモを含む
- **Sync Status**: サーバーとの同期状態。同期中、成功、失敗、リトライ中などのステータスを持つ
- **Google Sheets Row**: Running中セッションに対応するスプレッドシートの行。Running/Completedステータス、セッション情報、経過時間を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーがデバイスAでセッションを開始後、デバイスBでアプリを開いたとき、5秒以内に同じRunning中のセッションが表示される
- **SC-002**: 複数デバイスで同時に編集した場合、最後の更新が確実に反映され、データの不整合が発生しない
- **SC-003**: Google Sheets連携有効時、セッション開始から10秒以内にスプレッドシートに新しい行が追加される
- **SC-004**: Google Sheets同期エラーが発生してもアプリ内のタイムトラッカー機能は正常に動作し続ける（可用性99%以上）
- **SC-005**: LocalStorageモードでは従来通りの動作を維持し、既存ユーザーに影響を与えない（後方互換性100%）
- **SC-006**: ネットワークエラー発生時もアプリ内のタイムトラッカー機能は中断せず、ローカルで計測を継続できる

## Assumptions

- Supabaseのリアルタイム機能は使用せず、手動リロードで同期を実現する
- Google Sheets APIの呼び出し制限（1分あたり100リクエスト）を考慮し、Running状態の更新頻度を制限する
- 同期の競合解決はLast Write Winsパターンを採用し、マージロジックは実装しない
- Running中のセッションは1ユーザーあたり同時に1つまでとする（複数同時実行はサポートしない）
- ネットワークエラー時は自動リトライせず、ユーザーの明示的なアクション（リロード等）で同期を再開する

## Out of Scope

- オフライン→オンライン時の自動同期（オフライン中の変更を自動リトライで同期する機能）
- リアルタイム通知（Supabase Realtime/WebSocketを使った即時同期）
- Running状態の履歴管理（過去のRunning状態を記録する機能）
- 複数デバイス間での競合解決UI（ユーザーが手動で選択する機能）
- Running中セッションの複数同時実行サポート
- Google Sheets以外の外部サービスとの同期（Notion、Trelloなど）
