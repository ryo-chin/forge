# Feature Specification: Google Spreadsheet Integration for Time Tracker

**Feature Branch**: `001-app-features-time`
**Created**: 2025-10-12
**Status**: Draft
**Input**: User description: "現在のブランチで @app/features/time-tracker/pages/TimeTracker/TimeTrackerPage.tsx での計測 をGoogleスプレッドシートにも連携可能にしたいです。
なので
・Googleスプレッドシート連携
・どのシートのどのカラムにセッション情報の各要素をマッピングするかの設定ができる
などは最低限必要かと思います。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Automatic Sync to Google Spreadsheet (Priority: P1)

ユーザーは、Time Trackerでセッションを停止するたびに、自動的にGoogleスプレッドシートに同期されます。ユーザーは特別な操作を意識することなく、普段通り計測を行うだけで、データがアプリのDBとスプレッドシートの両方に保存されます。

**Why this priority**: これはこの機能の中核的な価値提供です。ユーザーが余計な操作をせずに、自然にデータがスプレッドシートに蓄積されることで、既存のレポートツールやワークフローとシームレスに統合できます。

**Independent Test**: ユーザーがセッションを停止し、指定したGoogleスプレッドシートに計測セッションデータが自動的に追加されることで、単独でテスト可能です。

**Acceptance Scenarios**:

1. **Given** スプレッドシート連携が設定済み, **When** ユーザーがセッションを停止する, **Then** セッションデータがDBとスプレッドシートの両方に同期的に保存される
2. **Given** スプレッドシートが既に過去のデータを含んでいる, **When** ユーザーが新しいセッションを停止する, **Then** 既存データを上書きせず、新しい行として追加される
3. **Given** スプレッドシートへの書き込みが失敗した, **When** セッションを停止する, **Then** DBへは保存され、エラー通知が表示される
4. **Given** DBへの書き込みが失敗した, **When** セッションを停止する, **Then** スプレッドシートへも書き込まず、エラー通知が表示される
5. **Given** ユーザーがGoogleアカウントに認証されていない, **When** 初回のセッション停止を試みる, **Then** Google認証フローが開始され、認証後に同期が実行される

---

### User Story 2 - Select Target Spreadsheet and Sheet (Priority: P1)

ユーザーは、同期先のGoogleスプレッドシートファイルとその中の特定のシート（タブ）を選択できます。

**Why this priority**: 複数のスプレッドシートや複数のシートを持つユーザーにとって、正しい場所にデータを書き込むことは必須です。P1の自動同期機能と同時に提供する必要があります。

**Independent Test**: ユーザーがスプレッドシートとシートを選択し、その場所にデータが同期されることで、単独でテスト可能です。

**Acceptance Scenarios**:

1. **Given** ユーザーがGoogleドライブに複数のスプレッドシートを持っている, **When** 設定画面でスプレッドシートを選択する, **Then** ユーザーのスプレッドシート一覧が表示され選択できる
2. **Given** 選択したスプレッドシートに複数のシートが存在する, **When** シートを選択する, **Then** そのスプレッドシート内のシート一覧が表示され選択できる
3. **Given** スプレッドシートとシートが選択されている, **When** セッションを停止する, **Then** 指定したシートにデータが追加される

---

### User Story 3 - Configure Spreadsheet Column Mapping (Priority: P2)

ユーザーは、Time Trackerのセッション情報（タイトル、開始時刻、終了時刻、経過時間、プロジェクトなど）を、Googleスプレッドシートのどのカラムにマッピングするかを設定できます。

**Why this priority**: ユーザーは既存のスプレッドシートフォーマットを持っている可能性があり、柔軟なマッピング機能がないと既存ワークフローとの統合が困難になります。P1の基本的な自動同期が動作した後に設定可能にすることで、段階的な価値提供が可能です。

**Independent Test**: ユーザーが設定画面でカラムマッピングを定義し、同期時に指定したカラムにデータが配置されることで、単独でテスト可能です。

**Acceptance Scenarios**:

1. **Given** ユーザーが設定画面を開いている, **When** 各セッション属性（title, startedAt, endedAt, durationSeconds, project）に対してスプレッドシートのカラム名を指定する, **Then** その設定が保存される
2. **Given** カスタムカラムマッピングが設定されている, **When** セッションを停止する, **Then** 指定したカラムにデータが配置される
3. **Given** スプレッドシートに存在しないカラム名が設定されている, **When** セッションを停止する, **Then** エラーメッセージを表示して同期を中断し、ユーザーに正しいカラム名を設定するよう促す

---

### User Story 4 - Manual Export for Past Sessions (Priority: P3)

ユーザーは、過去に記録したセッションを選択して、手動でGoogleスプレッドシートにエクスポートできます。

**Why this priority**: 自動同期が基本的な使い方として確立した後、過去データの補完や一括エクスポートなどの補助機能として提供できます。この機能がなくても、自動同期で十分な価値を提供できます。

**Independent Test**: ユーザーが過去のセッションを選択してエクスポートボタンをクリックし、スプレッドシートに追加されることで、単独でテスト可能です。

**Acceptance Scenarios**:

1. **Given** ユーザーが過去のセッションを複数選択している, **When** 手動エクスポートを実行する, **Then** 選択したセッションがスプレッドシートに追加される
2. **Given** 特定期間のセッションを選択している, **When** 手動エクスポートを実行する, **Then** その期間のセッションがスプレッドシートに追加される
3. **Given** 手動エクスポート中にエラーが発生した, **When** エクスポートが失敗する, **Then** エラー通知を表示し、どのセッションが失敗したかを示す

---

### Edge Cases

- スプレッドシートへの書き込み権限がない場合はどうなるか？
- ネットワーク接続が切断されている状態でセッションを停止した場合はどうなるか？
- Googleの認証トークンが期限切れになった状態でセッションを停止した場合はどうなるか？
- 複数のデバイスから同時に同じスプレッドシートに書き込んだ場合、データの整合性は保たれるか？
- カラムマッピング設定が不完全な場合（一部の属性だけ設定されている）はどうなるか？
- スプレッドシートの行数制限（通常500万行）に達した場合はどうなるか？
- DBへの書き込みは成功したがスプレッドシートへの書き込みが失敗した場合、ユーザーはどのように再同期できるか？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはセッション停止時に、DBとGoogleスプレッドシートの両方に同期的にデータを書き込まなければならない
- **FR-002**: システムはDBまたはスプレッドシートのいずれかへの書き込みが失敗した場合、ユーザーにエラー通知を表示しなければならない
- **FR-003**: システムはスプレッドシートへの書き込みが失敗してもDBへの保存は完了させなければならない
- **FR-004**: システムはDBへの書き込みが失敗した場合、スプレッドシートへも書き込まないようにしなければならない
- **FR-005**: システムはGoogle OAuth認証を使用してユーザーのGoogleアカウントへのアクセスを取得しなければならない
- **FR-006**: ユーザーは同期先のスプレッドシートファイルを選択できなければならない
- **FR-007**: ユーザーはスプレッドシート内の特定のシート（タブ）を選択できなければならない
- **FR-008**: ユーザーはセッション属性（title, startedAt, endedAt, durationSeconds, project, notes, tags, skill, intensity）をスプレッドシートのカラムにマッピングする設定を定義できなければならない
- **FR-009**: システムは同期時に既存のスプレッドシートデータを保持し、新しい行として追加しなければならない
- **FR-010**: システムはカラムマッピング設定を永続化しなければならない
- **FR-011**: システムはスプレッドシートとシートの選択設定を永続化しなければならない
- **FR-012**: システムはGoogle認証トークンを安全に保管し、期限切れ時に再認証を促さなければならない
- **FR-013**: ユーザーは過去のセッションを選択して手動でエクスポートできなければならない（P3機能）

### Key Entities

- **Google Spreadsheet Connection**: ユーザーのGoogleアカウント認証情報、選択されたスプレッドシートID、シート名を保持
- **Column Mapping Configuration**: Time Trackerセッション属性（title, startedAt, endedAt, durationSeconds, project, notes, tags, skill, intensity）とスプレッドシートカラム名の対応関係
- **Sync Log**: 同期履歴、成功/失敗ステータス、同期されたセッション、エラー詳細、タイムスタンプ

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは初回設定を5分以内に完了できる（Google認証、スプレッドシート選択、カラムマッピング設定）
- **SC-002**: セッション停止からスプレッドシートへの同期完了まで5秒以内に完了する
- **SC-003**: 同期成功率が95%以上である（ネットワークエラーを除く）
- **SC-004**: ユーザーの90%が設定画面でカラムマッピングを理解し、1回目の試行で正しく設定できる
- **SC-005**: ユーザーの80%が、普段通り計測を行うだけで自動的にスプレッドシートにデータが蓄積されていることを実感できる
- **SC-006**: 同期失敗時、ユーザーの95%が表示されたエラーメッセージから問題を理解し、適切な対処ができる
- **SC-007**: DBとスプレッドシートの両方への書き込み処理が、ユーザー体験を妨げない（セッション停止操作が即座に完了する）

## Assumptions

- ユーザーはGoogleアカウントを持っている
- ユーザーはGoogleスプレッドシートの基本的な使い方を理解している
- スプレッドシートの各カラムにはヘッダー行が存在する（1行目がヘッダー）
- データはスプレッドシートの最下行に追記される形式とする
- 日時データはローカルタイムゾーンの人間が読みやすい形式 (例: 2025/10/12 14:30:00) で出力する
- 経過時間（durationSeconds）は秒単位で出力するが、スプレッドシート側でのフォーマット変換はユーザーが行う
- DBへの書き込みとスプレッドシートへの書き込みは同期的に行われ、DBへの書き込みが成功してからスプレッドシートへ書き込む
- スプレッドシート連携はデフォルトで有効であり、設定で無効化も可能とする
