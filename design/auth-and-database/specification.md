# 認証・データ永続化 要件定義 v0.2

最終更新: 2025-09-25 / 作成: 開発チーム

---

## 1. 機能要件

### 1.1 認証
- **FR-1**: Google OAuth を利用したログイン/ログアウトフローを提供する（Supabase Auth の Google Provider を利用）。
- **FR-2**: Supabase Auth のセッション/JWT をクライアントで保持し、`@supabase/supabase-js` から直接 Supabase API を呼び出せるようにする。
- **FR-3**: リロード後も有効なセッションであれば自動リフレッシュし、ユーザーが再ログイン不要で利用を継続できる。

### 1.2 セッション管理
- **FR-4**: Supabase Database 上に `sessions` テーブル（仮）を作成し、ユーザー ID に紐づくセッションデータ（開始時刻、終了時刻、メタ情報など）を保存する。
- **FR-5**: フロントエンドから Supabase へ直接 CRUD を実行し、Row Level Security (RLS) により本人データのみ操作可能とする。
- **FR-6**: TanStack Query を用いてセッション一覧を取得・キャッシュし、mutation で更新後にキャッシュを適切に無効化/再取得する。

### 1.3 エラーハンドリング
- **FR-7**: 認証エラーや Supabase 接続エラーが発生した場合、ユーザー向けに再試行/問い合わせ手段を表示する。
- **FR-8**: 未認証状態で保護リソースにアクセスしようとした場合、ログイン画面へ誘導する。

### 1.4 将来拡張
- **FR-9**: Cloudflare Workers などの BFF を挟む構成に切り替える余地を残し、API コール箇所を抽象化しておく。

## 2. 非機能要件

### 2.1 パフォーマンス
- **NFR-1**: 認証フロー完了までのレスポンスを 3 秒以内に収める（Google OAuth のリダイレクト時間を除く）。
- **NFR-2**: セッション一覧取得クエリの応答時間を 1 秒以内に保つ（Supabase 側のクエリ含む）。

### 2.2 セキュリティ
- **NFR-3**: OAuth クライアント ID/シークレットは Cloudflare の環境変数（Secrets）で管理し、リポジトリに平文で置かない。
- **NFR-4**: Supabase への通信は HTTPS 経由で行い、RLS ポリシーで本人データ以外を遮断する。
- **NFR-5**: CSRF/Replay 対策として State パラメータや PKCE を利用する。

### 2.3 可用性・運用
- **NFR-6**: GitHub Actions から `npm install && npm run build` を実行するだけでデプロイ成果物が生成される。
- **NFR-7**: Cloudflare Pages/Workers の無料枠内で稼働できる利用量を想定する。

## 3. UI/UX
- ログインボタンはトップページに明示し、未ログイン時の主要アクションは制限する。
- セッション一覧には TanStack Query のキャッシュ/ローディング状態を活用し、Skeleton やリトライ UI を提供する。
- モバイル/デスクトップ両方で主要操作が行えるレスポンシブデザインを想定する。

## 4. 開発・テスト要件
- プロトタイプ実装は `prototype/<branch-name>/` 配下に限定する。
- Supabase のローカルエミュレーターは任意だが、Staging 用プロジェクトを用意して結合テストを実施する。
- E2E テストは余裕があれば Playwright 等で認証フローのハッピーパスを自動化する。

## 5. 移行/拡張要件
- 将来的にメール/パスワードや他 OAuth プロバイダ追加を想定し、抽象化した認証インターフェースを設計する。
- セッションデータはバージョンを持たせ、スキーマ変更時のマイグレーションを Supabase SQL Migration で管理する。
- Cloudflare Workers/BFF を導入する場合に備え、API 呼び出し層にラップを設けておく。

## 6. リスク・課題
- Supabase の無料枠リソース（DB スループット、Auth MAU）を越えると有償化が必要。
- Google OAuth の同意画面設定に時間がかかること。
- フロントエンド直アクセス構成ではネットワーク経路が利用者の環境に依存し、レイテンシ変動が大きくなる可能性。
