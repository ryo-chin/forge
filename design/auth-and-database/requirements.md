# 認証・データ永続化 要求定義 v0.2

最終更新: 2025-09-25 / 作成: 開発チーム

---

## 1. 背景と目的
- 新規・既存ユーザーが Google アカウントでシームレスにログインできる仕組みを提供し、ログイン後の操作を Cloudflare 上でホストされるプロトタイプから利用できるようにする。
- 個々のユーザーに紐づくセッションデータを永続化し、学習ログやアプリ利用履歴を後から参照・分析できる状態にする。
- すべての構成要素を無料枠で収め、継続的に検証・改善できる基盤を用意する。

## 2. ステークホルダー
- **エンドユーザー**: Web ブラウザからサービスを利用し、Google アカウントでサインインしたい個人。
- **開発チーム (prototype)**: プロトタイプを実装し、Cloudflare 上で動作させながら改善を行う担当者。
- **運用担当**: Supabase・Auth 管理、Google Cloud Console のクライアント ID 管理を行う担当者。

## 3. 成功指標
- 初回アクセスから 3 ステップ以内で Google ログインが完了する。
- ログイン後に行ったセッション開始/終了操作が Supabase に保存され、後続の画面リロード後も復元できる。
- Cloudflare Pages/Workers を利用した公開 URL から誰でもアクセスでき、無料枠内で稼働できている。

## 4. ユースケース
- **UC-1: ログイン**: ユーザーが「Google でログイン」ボタンを押し、OAuth 同意後にアプリへ戻る。
- **UC-2: セッション記録**: ログイン済みユーザーがセッションを作成/更新し、アプリ内状態および Supabase に記録する。
- **UC-3: セッション復元**: 再アクセス時に直近のセッション一覧が Supabase から読み込まれ、UI に表示される。

## 5. スコープ
- **含む**: 認証基盤整備、セッションデータの保存/取得、Cloudflare へのデプロイ、TanStack Query を用いたデータフェッチ。
- **含まない**: 課金機能、Supabase 以外のデータベース統合、モバイルアプリ対応、Google 以外の OAuth プロバイダ。

## 6. 制約条件
- Cloudflare+Supabase+Google OAuth の無料枠を超えない構成にする。
- プロトタイプ実装は `prototype/<branch-name>/` 配下に閉じ、他ディレクトリへ副作用を出さない。
- GitHub Actions から `BRANCH_NAME_RAW` / `SANITIZED_BRANCH` を受け取り、Cloudflare へのデプロイで活用できる構成とする。
- Supabase では Row Level Security を必須化し、ユーザー自身のデータ以外へアクセスできないようにする。

## 7. 未解決事項
- セッションデータのスキーマ詳細（保持する属性、TTL）。
- ログアウト時のセッション削除ポリシー。
- 監査ログの粒度や保存期間。
